const database = [
    {
        id: 'vnd331',
        title: 'Radisson Royal Hotel',
        details: 'Отель расположен в 4 минутах ходьбы от станции метро «Маяковская». К услугам гостей фитнес-центр и спа-центр с сауной и гидромассажной ванной.',
        photos: ['vnd331.png', 'vnd331.png'],
        coordinates: [59.9322936, 30.3460129],
        bookedDates: [],
        price: 12000
    },
    {
        id: 'ab2e2',
        title: 'Номера на Садовой',
        details: 'Расположен в 7 минутах ходьбы от Невского проспекта. К услугам гостей круглосуточная стойка регистрации и бесплатный Wi-Fi.',
        photos: ['ab2e2.png', 'ab2e2.png'],
        coordinates: [59.930325, 30.3291592],
        bookedDates: [],
        price: 4500
    },
    {
        id: 'mvm32l',
        title: 'Мини Отель на Невском 136',
        details: 'Мини-отель расположен в Санкт-Петербурге, в 5 минутах ходьбы от станции метро «Площадь Восстания» и Московского железнодорожного вокзала.',
        photos: ['mvm32l.png', 'mvm32l.png'],
        coordinates: [59.9299603, 30.3658932],
        bookedDates: [],
        price: 3800
    },
    {
        id: 'bvep12',
        title: 'Отель Усадьба Державина',
        details: 'Прекрасный отель недалеко от Исаакиевского собора с бесплатным Wi-Fi на всей территории.',
        photos: ['bvep12.png', 'bvep12.png'],
        coordinates: [59.9194966, 30.309389],
        bookedDates: [],
        price: 8700
    }
];
export function cloneDate(date) {
    return new Date(date.getTime());
}
export function addDays(date, days) {
    date.setDate(date.getDate() + days);
    return date;
}
export const backendPort = 3040;
export const localStorageKey = 'flat-rent-db';
export class FlatRentSdk {
    constructor() {
        this._generateTransactionId = () => {
            const min = 1000;
            const max = 9999;
            const num = Math.random() * (max - min) + min;
            return Math.floor(num);
        };
        if (this._readDatabase() == null) {
            this._writeDatabase(database);
        }
        this.database = this._readDatabase();
    }
    /**
     * Get flat by ID.
     *
     * @param {string} id Flat ID.
     * @returns {Promise<Object|null>} Flat.
     */
    get(id) {
        const flat = this.database.find((item) => {
            return item.id === id;
        });
        return Promise.resolve(flat == null ? flat : this._formatFlatObject(flat));
    }
    /**
     * Search for flats.
     *
     * @param {Object} parameters Search parameters
     * @param {string}parameters.city City name
     * @param {Date} parameters.checkInDate Check-in date
     * @param {Date} parameters.checkOutDate Check-out date
     * @param {number} [parameters.priceLimit] Max price for a night
     * @returns {Promise<[]>} List of suitable flats.
     */
    search(parameters) {
        console.log(parameters, parameters.city, parameters.city !== 'Санкт-Петербург');
        return new Promise((resolve, reject) => {
            try {
                if (parameters.city !== 'Санкт-Петербург') {
                    throw new Error(`Passed unsupported city - "${parameters.city}".`);
                }
                if (!(parameters.checkInDate instanceof Date) || !(parameters.checkOutDate instanceof Date)) {
                    throw new Error(`Passed invalid check-in or check-out date - from "${parameters.checkInDate}" to "${parameters.checkOutDate}".`);
                }
                this._assertDatesAreCorrect(parameters.checkInDate, parameters.checkOutDate);
                if (parameters.priceLimit != null && (isNaN(parameters.priceLimit) || !isFinite(parameters.priceLimit))) {
                    throw new Error(`Passed invalid price limit - "${parameters.priceLimit}".`);
                }
                let flats = this.database;
                if (parameters.priceLimit != null) {
                    flats = flats.filter((flat) => {
                        return flat.price <= parameters.priceLimit;
                    });
                }
                const dateRange = this._generateDateRange(parameters.checkInDate, parameters.checkOutDate);
                flats = flats.filter((flat) => {
                    return this._areAllDatesAvailable(flat, dateRange);
                });
                flats = flats.map((flat) => {
                    return this._formatFlatObject(flat, dateRange.length - 1);
                });
                resolve(flats);
            }
            catch (error) {
                reject(error);
            }
        });
    }
    /**
     * Book flat.
     *
     * @param {number} flatId
     * @param {Date} checkInDate
     * @param {Date} checkOutDate
     * @returns {number}
     */
    book(flatId, checkInDate, checkOutDate) {
        return new Promise((resolve, reject) => {
            try {
                const flat = this.database.find((item) => {
                    return item.id === flatId;
                });
                if (flat == null) {
                    throw new Error('There is no flat with ID "' + flatId + '".');
                }
                this._assertDatesAreCorrect(checkInDate, checkOutDate);
                const datesToBook = this._generateDateRange(checkInDate, checkOutDate);
                if (!this._areAllDatesAvailable(flat, datesToBook)) {
                    throw new Error(`Flat ${flat.id} is not available for dates ${datesToBook.join(',')}.`);
                }
                const bookedDates = datesToBook.map((date) => {
                    return date.getTime();
                });
                flat.bookedDates.push(...bookedDates);
                for (let i = 0; i < this.database.length; i++) {
                    if (this.database[i].id === flat.id) {
                        this.database[i] = flat;
                        break;
                    }
                }
                this._writeDatabase(this.database);
                resolve(this._generateTransactionId());
            }
            catch (error) {
                reject(error);
            }
        });
    }
    _assertDatesAreCorrect(checkInDate, checkOutDate) {
        const today = new Date();
        this._resetTime(today);
        this._resetTime(checkInDate);
        this._resetTime(checkOutDate);
        const diffToday = this._calculateDifferenceInDays(today, checkInDate);
        if (diffToday < 0) {
            throw new Error('Check-in date can\'t be in the past.');
        }
        const diffCheck = this._calculateDifferenceInDays(checkInDate, checkOutDate);
        if (diffCheck < 0) {
            throw new Error('Check-out date must be grater then check-in date.');
        }
    }
    _resetTime(date) {
        date.setHours(0);
        date.setMinutes(0);
        date.setSeconds(0);
        date.setMilliseconds(0);
    }
    _calculateDifferenceInDays(startDate, endDate) {
        const difference = endDate.getTime() - startDate.getTime();
        return Math.floor(difference / (1000 * 60 * 60 * 24));
    }
    _generateDateRange(from, to) {
        const dates = [];
        const differenceInDays = this._calculateDifferenceInDays(from, to);
        dates.push(new Date(from.getFullYear(), from.getMonth(), from.getDate()));
        for (let i = 1; i <= differenceInDays; i++) {
            dates.push(new Date(from.getFullYear(), from.getMonth(), from.getDate() + i));
        }
        return dates;
    }
    _areAllDatesAvailable(flat, dateRange) {
        return dateRange.every((date) => {
            return !flat.bookedDates.includes(date.getTime());
        });
    }
    _formatFlatObject(flat, nightNumber) {
        const formattedFlat = Object.assign({}, flat);
        formattedFlat.photos = formattedFlat.photos.map((photoUrl) => {
            return `http://localhost:${backendPort}/img/${photoUrl}`;
        });
        if (nightNumber != null) {
            formattedFlat.totalPrice = nightNumber * formattedFlat.price;
            delete formattedFlat.price;
        }
        return formattedFlat;
    }
    _readDatabase() {
        const data = window.localStorage.getItem(localStorageKey);
        if (data == null) {
            return data;
        }
        return JSON.parse(data);
    }
    _writeDatabase(database) {
        window.localStorage.setItem(localStorageKey, JSON.stringify(database));
    }
    _syncDatabase(database) {
        this._writeDatabase(database);
        this.database = this._readDatabase();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmxhdC1yZW50LXNkay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9mbGF0LXJlbnQtc2RrLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE1BQU0sUUFBUSxHQUFHO0lBQ2Y7UUFDRSxFQUFFLEVBQUUsUUFBUTtRQUNaLEtBQUssRUFBRSxzQkFBc0I7UUFDN0IsT0FBTyxFQUFFLGdKQUFnSjtRQUN6SixNQUFNLEVBQUUsQ0FBQyxZQUFZLEVBQUUsWUFBWSxDQUFDO1FBQ3BDLFdBQVcsRUFBRSxDQUFDLFVBQVUsRUFBQyxVQUFVLENBQUM7UUFDcEMsV0FBVyxFQUFFLEVBQUU7UUFDZixLQUFLLEVBQUUsS0FBSztLQUNiO0lBQ0Q7UUFDRSxFQUFFLEVBQUUsT0FBTztRQUNYLEtBQUssRUFBRSxtQkFBbUI7UUFDMUIsT0FBTyxFQUFFLDZIQUE2SDtRQUN0SSxNQUFNLEVBQUUsQ0FBQyxXQUFXLEVBQUUsV0FBVyxDQUFDO1FBQ2xDLFdBQVcsRUFBRSxDQUFDLFNBQVMsRUFBQyxVQUFVLENBQUM7UUFDbkMsV0FBVyxFQUFFLEVBQUU7UUFDZixLQUFLLEVBQUUsSUFBSTtLQUNaO0lBQ0Q7UUFDRSxFQUFFLEVBQUUsUUFBUTtRQUNaLEtBQUssRUFBRSwyQkFBMkI7UUFDbEMsT0FBTyxFQUFFLDJJQUEySTtRQUNwSixNQUFNLEVBQUUsQ0FBQyxZQUFZLEVBQUUsWUFBWSxDQUFDO1FBQ3BDLFdBQVcsRUFBRSxDQUFDLFVBQVUsRUFBQyxVQUFVLENBQUM7UUFDcEMsV0FBVyxFQUFFLEVBQUU7UUFDZixLQUFLLEVBQUUsSUFBSTtLQUNaO0lBQ0Q7UUFDRSxFQUFFLEVBQUUsUUFBUTtRQUNaLEtBQUssRUFBRSx5QkFBeUI7UUFDaEMsT0FBTyxFQUFFLDBGQUEwRjtRQUNuRyxNQUFNLEVBQUUsQ0FBQyxZQUFZLEVBQUUsWUFBWSxDQUFDO1FBQ3BDLFdBQVcsRUFBRSxDQUFDLFVBQVUsRUFBQyxTQUFTLENBQUM7UUFDbkMsV0FBVyxFQUFF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XG4gIHtcbiAgICBpZDogJ3ZuZDMzMScsXG4gICAgdGl0bGU6ICdSYWRpc3NvbiBSb3lhbCBIb3RlbCcsXG4gICAgZGV0YWlsczogJ9Ce0YLQtdC70Ywg0YDQsNGB0L/QvtC70L7QttC10L0g0LIgNCDQvNC40L3Rg9GC0LDRhSDRhdC+0LTRjNCx0Ysg0L7RgiDRgdGC0LDQvdGG0LjQuCDQvNC10YLRgNC+IMKr0JzQsNGP0LrQvtCy0YHQutCw0Y/Cuy4g0Jog0YPRgdC70YPQs9Cw0Lwg0LPQvtGB0YLQtdC5INGE0LjRgtC90LXRgS3RhtC10L3RgtGAINC4INGB0L/QsC3RhtC10L3RgtGAINGBINGB0LDRg9C90L7QuSDQuCDQs9C40LTRgNC+0LzQsNGB0YHQsNC20L3QvtC5INCy0LDQvdC90L7QuS4nLFxuICAgIHBob3RvczogWyd2bmQzMzEucG5nJywgJ3ZuZDMzMS5wbmcnXSxcbiAgICBjb29yZGluYXRlczogWzU5LjkzMjI5MzYsMzAuMzQ2MDEyOV0sXG4gICAgYm9va2VkRGF0ZXM6IFtdLFxuICAgIHByaWNlOiAxMjAwMFxuICB9LFxuICB7XG4gICAgaWQ6ICdhYjJlMicsXG4gICAgdGl0bGU6ICfQndC+0LzQtdGA0LAg0L3QsCDQodCw0LTQvtCy0L7QuScsXG4gICAgZGV0YWlsczogJ9Cg0LDRgdC/0L7Qu9C+0LbQtdC9INCyIDcg0LzQuNC90YPRgtCw0YUg0YXQvtC00YzQsdGLINC+0YIg0J3QtdCy0YHQutC+0LPQviDQv9GA0L7RgdC/0LXQutGC0LAuINCaINGD0YHQu9GD0LPQsNC8INCz0L7RgdGC0LXQuSDQutGA0YPQs9C70L7RgdGD0YLQvtGH0L3QsNGPINGB0YLQvtC50LrQsCDRgNC10LPQuNGB0YLRgNCw0YbQuNC4INC4INCx0LXRgdC/0LvQsNGC0L3Ri9C5IFdpLUZpLicsXG4gICAgcGhvdG9zOiBbJ2FiMmUyLnBuZycsICdhYjJlMi5wbmcnXSxcbiAgICBjb29yZGluYXRlczogWzU5LjkzMDMyNSwzMC4zMjkxNTkyXSxcbiAgICBib29rZWREYXRlczogW10sXG4gICAgcHJpY2U6IDQ1MDBcbiAgfSxcbiAge1xuICAgIGlkOiAnbXZtMzJsJyxcbiAgICB0aXRsZTogJ9Cc0LjQvdC4INCe0YLQtdC70Ywg0L3QsCDQndC10LLRgdC60L7QvCAxMzYnLFxuICAgIGRldGFpbHM6ICfQnNC40L3QuC3QvtGC0LXQu9GMINGA0LDRgdC/0L7Qu9C+0LbQtdC9INCyINCh0LDQvdC60YIt0J/QtdGC0LXRgNCx0YPRgNCz0LUsINCyIDUg0LzQuNC90YPRgtCw0YUg0YXQvtC00YzQsdGLINC+0YIg0YHRgtCw0L3RhtC40Lgg0LzQtdGC0YDQviDCq9Cf0LvQvtGJ0LDQtNGMINCS0L7RgdGB0YLQsNC90LjRj8K7INC4INCc0L7RgdC60L7QstGB0LrQvtCz0L4g0LbQtdC70LXQt9C90L7QtNC+0YDQvtC20L3QvtCz0L4g0LLQvtC60LfQsNC70LAuJyxcbiAgICBwaG90b3M6IFsnbXZtMzJsLnBuZycsICdtdm0zMmwucG5nJ10sXG4gICAgY29vcmRpbmF0ZXM6IFs1OS45Mjk5NjAzLDMwLjM2NTg5MzJdLFxuICAgIGJvb2tlZERhdGVzOiBbXSxcbiAgICBwcmljZTogMzgwMFxuICB9LFxuICB7XG4gICAgaWQ6ICdidmVwMTInLFxuICAgIHRpdGxlOiAn0J7RgtC10LvRjCDQo9GB0LDQtNGM0LHQsCDQlNC10YDQttCw0LLQuNC90LAnLFxuICAgIGRldGFpbHM6ICfQn9GA0LXQutGA0LDRgdC90YvQuSDQvtGC0LXQu9GMINC90LXQtNCw0LvQtdC60L4g0L7RgiDQmNGB0LDQsNC60LjQtdCy0YHQutC+0LPQviDRgdC+0LHQvtGA0LAg0YEg0LHQtdGB0L/Qu9Cw0YLQvdGL0LwgV2ktRmkg0L3QsCDQstGB0LXQuSDRgtC10YDRgNC40YLQvtGA0LjQuC4nLFxuICAgIHBob3RvczogWydidmVwMTIucG5nJywgJ2J2ZXAxMi5wbmcnXSxcbiAgICBjb29yZGluYXRlczogWzU5LjkxOTQ5NjYsMzAuMzA5Mzg5XSxcbiAgICBib29rZWREYXRlczogW10sXG4gICAgcHJpY2U6IDg3MDBcbiAgfVxuXVxuXG5leHBvcnQgZnVuY3Rpb24gY2xvbmVEYXRlKGRhdGUpIHtcbiAgcmV0dXJuIG5ldyBEYXRlKGRhdGUuZ2V0VGltZSgpKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gYWRkRGF5cyhkYXRlLCBkYXlzKSB7XG4gIGRhdGUuc2V0RGF0ZShkYXRlLmdldERhdGUoKSArIGRheXMpXG4gIHJldHVybiBkYXRlXG59XG5cbmV4cG9ydCBjb25zdCBiYWNrZW5kUG9ydCA9IDMwNDBcbmV4cG9ydCBjb25zdCBsb2NhbFN0b3JhZ2VLZXkgPSAnZmxhdC1yZW50LWRiJ1xuXG5leHBvcnQgY2xhc3MgRmxhdFJlbnRTZGsge1xuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBpZiAodGhpcy5fcmVhZERhdGFiYXNlKCkgPT0gbnVsbCkge1xuICAgICAgdGhpcy5fd3JpdGVEYXRhYmFzZShkYXRhYmFzZSlcbiAgICB9XG5cbiAgICB0aGlzLmRhdGFiYXNlID0gdGhpcy5fcmVhZERhdGFiYXNlKClcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgZmxhdCBieSBJRC5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IGlkIEZsYXQgSUQuXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPE9iamVjdHxudWxsPn0gRmxhdC5cbiAgICovXG4gIGdldChpZCkge1xuICAgIGNvbnN0IGZsYXQgPSB0aGlzLmRhdGFiYXNlLmZpbmQoKGl0ZW0pID0+IHtcbiAgICAgIHJldHVybiBpdGVtLmlkID09PSBpZFxuICAgIH0pXG5cbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGZsYXQgPT0gbnVsbCA/IGZsYXQgOiB0aGlzLl9mb3JtYXRGbGF0T2JqZWN0KGZsYXQpKVxuICB9XG5cbiAgLyoqXG4gICAqIFNlYXJjaCBmb3IgZmxhdHMuXG4gICAqXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBwYXJhbWV0ZXJzIFNlYXJjaCBwYXJhbWV0ZXJzXG4gICAqIEBwYXJhbSB7c3RyaW5nfXBhcmFtZXRlcnMuY2l0eSBDaXR5IG5hbWVcbiAgICogQHBhcmFtIHtEYXRlfSBwYXJhbWV0ZXJzLmNoZWNrSW5EYXRlIENoZWNrLWluIGRhdGVcbiAgICogQHBhcmFtIHtEYXRlfSBwYXJhbWV0ZXJzLmNoZWNrT3V0RGF0ZSBDaGVjay1vdXQgZGF0ZVxuICAgKiBAcGFyYW0ge251bWJlcn0gW3BhcmFtZXRlcnMucHJpY2VMaW1pdF0gTWF4IHByaWNlIGZvciBhIG5pZ2h0XG4gICAqIEByZXR1cm5zIHtQcm9taXNlPFtdPn0gTGlzdCBvZiBzdWl0YWJsZSBmbGF0cy5cbiAgICovXG4gIHNlYXJjaChwYXJhbWV0ZXJzKSB7XG4gICAgY29uc29sZS5sb2cocGFyYW1ldGVycyxwYXJhbWV0ZXJzLmNpdHksIHBhcmFtZXRlcnMuY2l0eSAhPT0gJ9Ch0LDQvdC60YIt0J/QtdGC0LXRgNCx0YPRgNCzJylcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgaWYgKHBhcmFtZXRlcnMuY2l0eSAhPT0gJ9Ch0LDQvdC60YIt0J/QtdGC0LXRgNCx0YPRgNCzJykge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgUGFzc2VkIHVuc3VwcG9ydGVkIGNpdHkgLSBcIiR7cGFyYW1ldGVycy5jaXR5fVwiLmApXG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIShwYXJhbWV0ZXJzLmNoZWNrSW5EYXRlIGluc3RhbmNlb2YgRGF0ZSkgfHwgIShwYXJhbWV0ZXJzLmNoZWNrT3V0RGF0ZSBpbnN0YW5jZW9mIERhdGUpKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBQYXNzZWQgaW52YWxpZCBjaGVjay1pbiBvciBjaGVjay1vdXQgZGF0ZSAtIGZyb20gXCIke3BhcmFtZXRlcnMuY2hlY2tJbkRhdGV9XCIgdG8gXCIke3BhcmFtZXRlcnMuY2hlY2tPdXREYXRlfVwiLmApXG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5fYXNzZXJ0RGF0ZXNBcmVDb3JyZWN0KHBhcmFtZXRlcnMuY2hlY2tJbkRhdGUsIHBhcmFtZXRlcnMuY2hlY2tPdXREYXRlKVxuXG4gICAgICAgIGlmIChwYXJhbWV0ZXJzLnByaWNlTGltaXQgIT0gbnVsbCAmJiAoaXNOYU4ocGFyYW1ldGVycy5wcmljZUxpbWl0KSB8fCAhaXNGaW5pdGUocGFyYW1ldGVycy5wcmljZUxpbWl0KSkpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFBhc3NlZCBpbnZhbGlkIHByaWNlIGxpbWl0IC0gXCIke3BhcmFtZXRlcnMucHJpY2VMaW1pdH1cIi5gKVxuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGZsYXRzID0gdGhpcy5kYXRhYmFzZVxuXG4gICAgICAgIGlmIChwYXJhbWV0ZXJzLnByaWNlTGltaXQgIT0gbnVsbCkge1xuICAgICAgICAgIGZsYXRzID0gZmxhdHMuZmlsdGVyKChmbGF0KSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gZmxhdC5wcmljZSA8PSBwYXJhbWV0ZXJzLnByaWNlTGltaXRcbiAgICAgICAgICB9KVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZGF0ZVJhbmdlID0gdGhpcy5fZ2VuZXJhdGVEYXRlUmFuZ2UocGFyYW1ldGVycy5jaGVja0luRGF0ZSwgcGFyYW1ldGVycy5jaGVja091dERhdGUpXG4gICAgICAgIGZsYXRzID0gZmxhdHMuZmlsdGVyKChmbGF0KSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuX2FyZUFsbERhdGVzQXZhaWxhYmxlKGZsYXQsIGRhdGVSYW5nZSlcbiAgICAgICAgfSlcblxuICAgICAgICBmbGF0cyA9IGZsYXRzLm1hcCgoZmxhdCkgPT4ge1xuICAgICAgICAgIHJldHVybiB0aGlzLl9mb3JtYXRGbGF0T2JqZWN0KGZsYXQsIGRhdGVSYW5nZS5sZW5ndGggLSAxKVxuICAgICAgICB9KVxuXG4gICAgICAgIHJlc29sdmUoZmxhdHMpXG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICByZWplY3QoZXJyb3IpXG4gICAgICB9XG4gICAgfSlcblxuXG4gIH1cblxuICAvKipcbiAgICogQm9vayBmbGF0LlxuICAgKlxuICAgKiBAcGFyYW0ge251bWJlcn0gZmxhdElkXG4gICAqIEBwYXJhbSB7RGF0ZX0gY2hlY2tJbkRhdGVcbiAgICogQHBhcmFtIHtEYXRlfSBjaGVja091dERhdGVcbiAgICogQHJldHVybnMge251bWJlcn1cbiAgICovXG4gIGJvb2soZmxhdElkLCBjaGVja0luRGF0ZSwgY2hlY2tPdXREYXRlKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IGZsYXQgPSB0aGlzLmRhdGFiYXNlLmZpbmQoKGl0ZW0pID0+IHtcbiAgICAgICAgICByZXR1cm4gaXRlbS5pZCA9PT0gZmxhdElkXG4gICAgICAgIH0pXG5cbiAgICAgICAgaWYgKGZsYXQgPT0gbnVsbCkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVGhlcmUgaXMgbm8gZmxhdCB3aXRoIElEIFwiJyArIGZsYXRJZCArICdcIi4nKVxuICAgICAgICB9XG4gICAgICAgIHRoaXMuX2Fzc2VydERhdGVzQXJlQ29ycmVjdChjaGVja0luRGF0ZSwgY2hlY2tPdXREYXRlKVxuXG4gICAgICAgIGNvbnN0IGRhdGVzVG9Cb29rID0gdGhpcy5fZ2VuZXJhdGVEYXRlUmFuZ2UoY2hlY2tJbkRhdGUsIGNoZWNrT3V0RGF0ZSlcbiAgICAgICAgaWYgKCF0aGlzLl9hcmVBbGxEYXRlc0F2YWlsYWJsZShmbGF0LCBkYXRlc1RvQm9vaykpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZsYXQgJHtmbGF0LmlkfSBpcyBub3QgYXZhaWxhYmxlIGZvciBkYXRlcyAke2RhdGVzVG9Cb29rLmpvaW4oJywnKX0uYClcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGJvb2tlZERhdGVzID0gZGF0ZXNUb0Jvb2subWFwKChkYXRlKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIGRhdGUuZ2V0VGltZSgpXG4gICAgICAgIH0pXG4gICAgICAgIGZsYXQuYm9va2VkRGF0ZXMucHVzaCguLi5ib29rZWREYXRlcylcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmRhdGFiYXNlLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgaWYgKHRoaXMuZGF0YWJhc2VbaV0uaWQgPT09IGZsYXQuaWQpIHtcbiAgICAgICAgICAgIHRoaXMuZGF0YWJhc2VbaV0gPSBmbGF0XG4gICAgICAgICAgICBicmVha1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB0aGlzLl93cml0ZURhdGFiYXNlKHRoaXMuZGF0YWJhc2UpXG5cbiAgICAgICAgcmVzb2x2ZSh0aGlzLl9nZW5lcmF0ZVRyYW5zYWN0aW9uSWQoKSlcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIHJlamVjdChlcnJvcilcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgX2Fzc2VydERhdGVzQXJlQ29ycmVjdChjaGVja0luRGF0ZSwgY2hlY2tPdXREYXRlKSB7XG4gICAgY29uc3QgdG9kYXkgPSBuZXcgRGF0ZSgpXG4gICAgdGhpcy5fcmVzZXRUaW1lKHRvZGF5KVxuICAgIHRoaXMuX3Jlc2V0VGltZShjaGVja0luRGF0ZSlcbiAgICB0aGlzLl9yZXNldFRpbWUoY2hlY2tPdXREYXRlKVxuXG4gICAgY29uc3QgZGlmZlRvZGF5ID0gdGhpcy5fY2FsY3VsYXRlRGlmZmVyZW5jZUluRGF5cyh0b2RheSwgY2hlY2tJbkRhdGUpXG4gICAgaWYgKGRpZmZUb2RheSA8IDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2hlY2staW4gZGF0ZSBjYW5cXCd0IGJlIGluIHRoZSBwYXN0LicpXG4gICAgfVxuXG4gICAgY29uc3QgZGlmZkNoZWNrID0gdGhpcy5fY2FsY3VsYXRlRGlmZmVyZW5jZUluRGF5cyhjaGVja0luRGF0ZSwgY2hlY2tPdXREYXRlKVxuICAgIGlmIChkaWZmQ2hlY2sgPCAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NoZWNrLW91dCBkYXRlIG11c3QgYmUgZ3JhdGVyIHRoZW4gY2hlY2staW4gZGF0ZS4nKVxuICAgIH1cbiAgfVxuXG4gIF9yZXNldFRpbWUoZGF0ZSkge1xuICAgIGRhdGUuc2V0SG91cnMoMClcbiAgICBkYXRlLnNldE1pbnV0ZXMoMClcbiAgICBkYXRlLnNldFNlY29uZHMoMClcbiAgICBkYXRlLnNldE1pbGxpc2Vjb25kcygwKVxuICB9XG5cbiAgX2NhbGN1bGF0ZURpZmZlcmVuY2VJbkRheXMoc3RhcnREYXRlLCBlbmREYXRlKSB7XG4gICAgY29uc3QgZGlmZmVyZW5jZSA9IGVuZERhdGUuZ2V0VGltZSgpIC0gc3RhcnREYXRlLmdldFRpbWUoKVxuXG4gICAgcmV0dXJuIE1hdGguZmxvb3IoZGlmZmVyZW5jZSAvICgxMDAwICogNjAgKiA2MCAqIDI0KSlcbiAgfVxuXG4gIF9nZW5lcmF0ZURhdGVSYW5nZShmcm9tLCB0bykge1xuICAgIGNvbnN0IGRhdGVzID0gW11cbiAgICBjb25zdCBkaWZmZXJlbmNlSW5EYXlzID0gdGhpcy5fY2FsY3VsYXRlRGlmZmVyZW5jZUluRGF5cyhmcm9tLCB0bylcblxuICAgIGRhdGVzLnB1c2gobmV3IERhdGUoZnJvbS5nZXRGdWxsWWVhcigpLCBmcm9tLmdldE1vbnRoKCksIGZyb20uZ2V0RGF0ZSgpKSlcbiAgICBmb3IgKGxldCBpID0gMTsgaSA8PSBkaWZmZXJlbmNlSW5EYXlzOyBpKyspIHtcbiAgICAgIGRhdGVzLnB1c2gobmV3IERhdGUoZnJvbS5nZXRGdWxsWWVhcigpLCBmcm9tLmdldE1vbnRoKCksIGZyb20uZ2V0RGF0ZSgpICsgaSkpXG4gICAgfVxuXG4gICAgcmV0dXJuIGRhdGVzXG4gIH1cblxuICBfZ2VuZXJhdGVUcmFuc2FjdGlvbklkID0gKCkgPT4ge1xuICAgIGNvbnN0IG1pbiA9IDEwMDBcbiAgICBjb25zdCBtYXggPSA5OTk5XG4gICAgY29uc3QgbnVtID0gTWF0aC5yYW5kb20oKSAqIChtYXggLSBtaW4pICsgbWluXG5cbiAgICByZXR1cm4gTWF0aC5mbG9vcihudW0pXG4gIH1cblxuICBfYXJlQWxsRGF0ZXNBdmFpbGFibGUoZmxhdCwgZGF0ZVJhbmdlKSB7XG4gICAgcmV0dXJuIGRhdGVSYW5nZS5ldmVyeSgoZGF0ZSkgPT4ge1xuICAgICAgcmV0dXJuICFmbGF0LmJvb2tlZERhdGVzLmluY2x1ZGVzKGRhdGUuZ2V0VGltZSgpKVxuICAgIH0pXG4gIH1cblxuICBfZm9ybWF0RmxhdE9iamVjdChmbGF0LCBuaWdodE51bWJlcikge1xuICAgIGNvbnN0IGZvcm1hdHRlZEZsYXQgPSBPYmplY3QuYXNzaWduKHt9LCBmbGF0KVxuXG4gICAgZm9ybWF0dGVkRmxhdC5waG90b3MgPSBmb3JtYXR0ZWRGbGF0LnBob3Rvcy5tYXAoKHBob3RvVXJsKSA9PiB7XG4gICAgICByZXR1cm4gYGh0dHA6Ly9sb2NhbGhvc3Q6JHtiYWNrZW5kUG9ydH0vaW1nLyR7cGhvdG9Vcmx9YFxuICAgIH0pXG5cbiAgICBpZiAobmlnaHROdW1iZXIgIT0gbnVsbCkge1xuICAgICAgZm9ybWF0dGVkRmxhdC50b3RhbFByaWNlID0gbmlnaHROdW1iZXIgKiBmb3JtYXR0ZWRGbGF0LnByaWNlXG4gICAgICBkZWxldGUgZm9ybWF0dGVkRmxhdC5wcmljZVxuICAgIH1cblxuICAgIHJldHVybiBmb3JtYXR0ZWRGbGF0XG4gIH1cblxuICBfcmVhZERhdGFiYXNlKCkge1xuICAgIGNvbnN0IGRhdGEgPSB3aW5kb3cubG9jYWxTdG9yYWdlLmdldEl0ZW0obG9jYWxTdG9yYWdlS2V5KVxuXG4gICAgaWYgKGRhdGEgPT0gbnVsbCkge1xuICAgICAgcmV0dXJuIGRhdGFcbiAgICB9XG5cbiAgICByZXR1cm4gSlNPTi5wYXJzZShkYXRhKVxuICB9XG5cbiAgX3dyaXRlRGF0YWJhc2UoZGF0YWJhc2UpIHtcbiAgICB3aW5kb3cubG9jYWxTdG9yYWdlLnNldEl0ZW0obG9jYWxTdG9yYWdlS2V5LCBKU09OLnN0cmluZ2lmeShkYXRhYmFzZSkpXG4gIH1cblxuICBfc3luY0RhdGFiYXNlKGRhdGFiYXNlKSB7XG4gICAgdGhpcy5fd3JpdGVEYXRhYmFzZShkYXRhYmFzZSlcbiAgICB0aGlzLmRhdGFiYXNlID0gdGhpcy5fcmVhZERhdGFiYXNlKClcbiAgfVxufVxuIl19